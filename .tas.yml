version: 2.0
nodeVersion: 14.17.3
tier: large
smartRun: false
postMerge:
  preRun:
     env:
       FORCE_COLOR: true
       NODE_OPTIONS: "--max-old-space-size=8096"
       LOCKBOX_MASTER_KEY: lockbox-master-key
       SECRET_KEY_BASE: secrret-key-base
       PG_HOST: localhost
       PG_PORT: 5432
       PG_USER: tas
       PG_PASS: tas
       PG_DB: tooljet_test
       POSTGRES_PASSWORD: tas
       NODE_ENV: test
     command:
#         - cp /usr/local/bin/bundle /home/nucleus/bundle
        - apt update
        - apt install build-essential -y
        # - apt install postgresql -y
        # - apt install postgresql-contrib -y
        # - /etc/init.d/postgresql start
        # - su -c "psql -c \"ALTER USER postgres PASSWORD 'postgres';\"" postgres
        - npm i -g npm@7.20.0
        - npm --prefix plugins install
        - npm --prefix plugins run create:client && npm --prefix plugins run create:server
        - npm --prefix plugins run build:packages && npm --prefix plugins run build:server
        - npm --prefix server install
        # - npm --prefix server run db:create
        # - npm --prefix server run db:migrate
  subModules:
      - name: server      
        path : "./server"
        smartRun: false
        pattern: 
          # - "./setup-postgres.js"
          - "./test/services/*.ts"
        framework : jest
        parallelism: 2
        splitMode: file
        # nodeVersion: 14.17.3
        runPreRunEveryTime: true
        preRun:
          env:
            FORCE_COLOR: true
            NODE_OPTIONS: "--max-old-space-size=8096"
            LOCKBOX_MASTER_KEY: lockbox-master-key
            SECRET_KEY_BASE: secrret-key-base
            PG_HOST: localhost
            PG_PORT: 5432
            PG_USER: tas
            PG_PASS: tas
            PG_DB: tooljet_test
            POSTGRES_PASSWORD: tas
            NODE_ENV: test
          command:
#             - cp /usr/local/bin/bundle /home/nucleus/bundle
            - apt install postgresql-13 sudo -y
            - apt install build-essential -y
            - sed -i 's/peer/trust/'  /etc/postgresql/13/main/pg_hba.conf
            - /etc/init.d/postgresql start
            - sudo -u postgres psql -c "CREATE USER tas WITH SUPERUSER PASSWORD 'tas';"
#             - CREATE USER runner WITH PASSWORD '$password' CREATEDB;
#             - psql ALTER USER postgres PASSWORD 'postgres';
#             - su -c "psql -c \"ALTER USER postgres PASSWORD 'postgres';\"" postgres
#             - npm i -g npm@7.20.0
            - npm install
#             - npm install jest-cli
            - npm run db:create
            - npm run db:migrate
#             - rm -rf /usr/local/bin/bundle
#             - touch /usr/local/bin/bundle
            # - rm -rf /usr/local/bin/bundle
            # - npm install yjs
            # - npm install -g yjs
            # - npm i --legacy-peer-deps @lambdatest/test-at-scale-jasmine-runner@~0.3.0 @lambdatest/test-at-scale-mocha-runner@~0.3.0 @lambdatest/test-at-scale-jest-runner@~0.3.0
        configFile : "./jest.config.ts"


